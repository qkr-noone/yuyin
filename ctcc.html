<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<link rel="stylesheet" href="../css/yuyin.fonts.css" />
	<link rel="stylesheet" href="../css/yy.css" />
	<link rel="stylesheet" href="../css/yuyin.isp.css" />
	<link rel="icon" href="../img/app/yuyinfavicon.ico" />
	<title></title>

</head>
<body>
<div id="loading">
	<div class="yyloader">
			<span></span>
			<span></span>
			<span></span>
			<img src="http://up.wawa.fm/21,019486d41d666e"/>
	</div>
</div>
<div class="pager rpage" id="order">
 <div id="ringInfo">
		<div class="isp_tit">
			<h1 id="ring" class="change_choose" >
				<p>Ring-back</p><p>彩铃</p>
			</h1>
		</div>
		<div class="ring_de">
			<div class="isp_cont">
				<div class="ring_info" id="ring_info">
				</div>
				<div class="ring_buy_type change_set">
					<a id="first_buy" href="#!order/singleInfo">单首订购</a>
					<a id="month_buy" href="#!order/monthInfo">包月订购</a>
				</div>
				<div class="ring_tip rm_ring_tip" ><p>单首订购的咨询费为 <strong>2元/首</strong>，包月订购则为 <strong>6元/月</strong></p>
				</div>
			</div>
			<div class="line"></div>
			<div class="ring_tip_2">
				<p>1、开通彩铃会员后可免费不限次数的更换所有彩铃<p>2、彩铃包月服务需开通彩铃功能，5元/月，由运营商收取；若您未开通，我们将一并为您开通；若您已开通，请忽略此项。</p>
				</p>
			</div>
		</div>
 </div>
 <div id="taskInfo">		
 </div>
 <div id="singleInfo">
		<div class="isp_tit">
			<h1 id="ring" class="change_choose" >
				<p>Single Song</p><p>单首</p>
			</h1>
		</div>
		<!-- 修改 -->
		<div class="login" id="loginSingle">
			<input class="tel_val" id="sbphone" type="tel" placeholder="电信手机号码" maxlength="11">
			<div class="tel_re">
				<input class="tel_ma" id="sbkey" type="tel" placeholder="验证码" maxlength="6">
				<a class="send_ma disabled" id="sbcode">发送验证码</a>
			</div>
			<a class="send_ma send_ring disabled" id="sPayOrder">设为彩铃</a>
			<div class="ring_tip_2 send_ring_tip">
				<p>1、订购单首彩铃（2元/首）</p><p>2、彩铃单首服务需开通彩铃功能，5元/月，运营商收取；若您未开通，请先开通该功能；若您已开通，请忽略此项。</p>
			</div>
		</div>
 </div>
 <div id="monthInfo">
		<div class="isp_tit">
			<h1 id="ring" class="change_choose" >
				<p>Open monthly</p><p>包月</p>
			</h1>
		</div>
		<div class="login" id="loginMonth">
			<input class="tel_val" id="mbphone" type="tel" placeholder="电信手机号码" maxlength="11">
			<div class="tel_re">
				<input class="tel_ma" id="mbkey" type="tel" placeholder="验证码" maxlength="4">
				<a class="send_ma disabled" id="mbcode">发送验证码</a>
			</div>
			<a class="send_ma send_ring disabled" id="mPayOrder">设为彩铃</a>
			<div class="ring_tip_2 send_ring_tip">
				<p>1、开通彩铃包月服务（6元/月），开通后可免费不限次数的更换所有彩铃.</p><p>2、彩铃包月服务需开通彩铃功能（5元/月），由运营商收取；若您未开通，我们将一并为您开通；若您已开通，请忽略此项.</p>
			</div>
		</div>
 </div>
</div>
<div class="pager rpage" id="index">
	<nav class="isp_tit">
		<a id="ring" href="#!index/home"  class="change_choose" >
			<p>Ring-back</p><p>彩铃</p>
		</a>
		<a id="search" href="#!index/search">
			<p>SEARCH</p><p>搜索</p>
		</a>
		<a id="me" href="#!index/user">
			<p>My Rings</p><p>我的</p>
		</a>
	</nav>
	<div class="ring_de" id="home">
		<div class="isp_cont">
			<div class="ring_info" id="home_ring_info">				
			</div>
			<div class="ring_buy_type change_set">
				<a id="first_buy" href="#!order/singleInfo">单首订购</a>
				<a id="month_buy" href="#!order/monthInfo">包月订购</a>
			</div>
			<div class="ring_tip rm_ring_tip"><p>单首订购的咨询费为 <strong>2元/首</strong>；包月订购则为 <strong>6元/月</strong>，在期限内可免费不限次数的更换所有彩铃</p>
			</div>
		</div>
		<div class="line"></div>
		<div class="ring_song">
			<ul class="tab_type" id="tabslist">
				<li cate="3" target="#main_list1" class="choose_tab"><h1 class="tab_title">热门推荐</h1><h4 class="tab_mintitle">RECOMMEND</h4></li>
				<li cate="4" target="#main_list2"><h1 class="tab_title">挖哇专区</h1><h4 class="tab_mintitle">WAWA AREA</h4></li>
				<li cate="5" target="#main_list3"><h1 class="tab_title">民谣摇滚</h1><h4 class="tab_mintitle">ROCK&FOLK</h4></li>
				<li cate="6" target="#main_list4"><h1 class="tab_title">影视原声</h1><h4 class="tab_mintitle">OST</h4></li>
			</ul>
		</div>
		<div class="rlist_box" id="rlist_box">
			<ul id="main_list1"></ul>
			<ul id="main_list2"></ul>
			<ul id="main_list3"></ul>
			<ul id="main_list4"></ul>
		</div>
	</div>
	<div class="search_de" id="searchInfo">
		<div class="filter_box">
			<i class="icon-search"></i><input class="search" id="key" type="search" name="" placeholder="请输入检索内容">
			<input type="button" class="find" id="find" value="搜索">
		</div>
		<ul class="filter_info" id="filter_info"></ul>
	</div>
	<div class="me_de" id="user">
		<div class="login" id="login">
			<h1 class="headline bolder">开通包月</h1>
			<p class="subline">免费彩铃随意更换</p>
			<input class="tel_val" id="obphone" type="tel" placeholder="电信手机号码" maxlength="11">
			<div class="tel_re">
				<input class="tel_ma" id="obkey" type="tel" placeholder="验证码" maxlength="4">
				<a class="send_ma disabled" id="obcode">发送验证码</a>
			</div>
			<a class="send_ma send_ring disabled" id="oPayOrder">设为彩铃</a>
			<div class="ring_tip_2 send_ring_tip">
				<p>1、开通彩铃包月服务（6元/月），开通后可免费不限次数的更换所有彩铃.</p><p>2、彩铃包月服务需开通彩铃功能（5元/月），由运营商收取；若您未开通，我们将一并为您开通；若您已开通，请忽略此项.</p>
				<p>3、该服务为包月服务，当月取消，次月生效。不取消则默认继续使用该服务.</p>
				<p>4、业务退订方式：进入 [我的] 页面 - 点击 [取消包月] - 完成退订；或者拨打10000客服电话进行退订.</p>
			</div>
		</div>
		<div class="me_info" id="me_info">
			<div class="isp_cont" style="margin: 0">
				<div class="ring_info">
					<img class="ring_cover_head" id="logout" src="../img/yuyin/avatar.png">
					<img class="ring_cover_bg" src="../img/yuyin/isp/ring_buttom_bg.png">
					<i class="icon-play-button"></i>
					<div class="ring_name">
						<h4 class="ellipsis">电信手机号码</h4><h2 class="bolder ellipsis" id="admin_phone"></h2>
					</div>
				</div>
				<div class="ring_buy_type">
					<a id="mpybtn">取消包月</a>
				</div>
				<div class="ring_tip"><p>点击头像可注销账号，该账号目前共订购有<strong id="ulist_num"></strong>首彩铃</p>
				</div>
			</div>
			<div class="line" style="margin: 0"></div>
			<div class="rlist_box" style="margin: 0">
				<ul id="ulist_box">					
				</ul>
			</div>
		</div>
		<div class="change_ring">
			<ul>
				<li id="set_my_ring">
					<i class="icon-isp"></i>
					<div class="comp_de">
						<h2 class="bolder">设为彩铃</h2>
						<h4>Change My Ring</h4>
					</div>
				</li>
			</ul>
		</div>
	</div>	
</div>
<div class="res_page" id="res_page">
    <i class="res_icon icon-success" id="res_icon"></i>
    <h1 class="bolder" id="res_title"></h1>
    <p id="res_desc"></p>
    <div id="res_btns" class="res_btns resbtn bolder"></div>
</div>
<audio id="audio" preload="preload" ></audio>
<!-- <div class="article_info ">
    <div class="isp_content">
        彩铃 follow your H 
    </div>
    <div id="isp_play">播放彩铃</div>
    <div id="close_current">关闭当前打开的webview</div>
    <div id="tran_href">跳转webview</div>
</div> -->
	
	<script src="../js/jquery.js"></script>
	<script src="../js/jquery.cookie.min.js"></script>
	<script src="../js/jquery.validate.min.js"></script>
	<script src="../js/md5.min.js"></script>
	<script src="../js/yy.js"></script>
	<script src="../js/q.js"></script>
	<script>		
		$(function(){
			var $win= $(window),
					$doc= $(document),
					$filter_info = $('#filter_info'),
					isSearch = false,
					$find = $('#find'),
					$key = $('#key'),
					$loading = $('#loading'),
					$title = $('title'),
					$nav_item = $("nav").find("a"),
					$index = $('#index'),
					$home = $('#home'),
					$searchInfo = $('#searchInfo'),
					$order = $('#order'),
					$user = $('#user'),
					$ringInfo = $('#ringInfo'),
					$taskInfo = $('#taskInfo'),
					$login = $('#login'),
					$meInfo = $('#me_info'),
          $mainList1 = $('#main_list1'),
          $rlist_box = $('#rlist_box'),
          $tabs = $('#tabslist').find('li'),
          isLoad = false,
          audio = document.getElementById('audio'),
          user = { phone: '', isOpen: false, isBase: false, uid: 0, token: '' },
          phone = '',
          code = '',
          ctcc = $.yy['getQuery']('ctcc'),
          crbt_id = '',
          crbt_songname = '',
          $home_ring_info = $('#home_ring_info'),
          $ring_info = $('#ring_info'),
          $first_buy = $('#first_buy'),
          $month_buy = $('#month_buy'),
          $monthInfo = $('#monthInfo'),
          $singleInfo = $('#singleInfo'),
          $rpage = $(".rpage"),
          $res_page = $("#res_page"),
          $res_icon = $("#res_icon"),
          $res_title = $("#res_title"),
          $res_desc = $("#res_desc"),
          $res_btns = $("#res_btns"),
          $ulist_box = $("#ulist_box"),
          $ulist_num = $("#ulist_num"),
          $mpybtn = $("#mpybtn"),
          $admin_phone = $("#admin_phone"),
          $loginMonth = $("#loginMonth"),
          $monthTip = $("#monthTip"),
          $change_set = $(".change_set"),
          $setRing = $("#setRing"),
          $ring_tip = $(".ring_tip"),
          $rm_ring_tip = $(".rm_ring_tip"),
          $logout = $("#logout"),
          $set_my_ring = $("#set_my_ring"),
          com_songname = '',
          com_tid = '';

			Q.reg(['index', 'order', 'user']);
			Q.init({
				index: 'index',
				pop:navchange = function(page, query) {
					var a;//临时变量
    			switch (page) {
            	case "index":
            	    $nav_item.removeClass("change_choose");
            	    $("nav>a[href='#!" + page + "/" + (query || 'home') + "']").addClass('change_choose');
            	    switch (query) {
            	        case "search":
            	            $title.html('搜索彩铃');
            	            $searchInfo.show();
            	            $user.hide();
            	            $home.hide();
            	            break;
            	        case "user":
            	            $title.html('我的彩铃');
            	            if (user['phone'] && $ulist_box.children("li").length == 0) {  //测试 li 为 0
            	            	getUserList(user['phone']);
            	            }
            	            $user.show();
            	            $searchInfo.hide();
            	            $home.hide();
            	            user['phone'] ? $meInfo.show() : $login.show();
            	            break;
            	        default:
            	            $title.html('设置彩铃');
            	            $home.show();
            	            $user.hide();
            	            $searchInfo.hide();
            	            break;
            	    }
            	    $index.show();
            	    $order.hide();
            	    break;
            	case "order":
            	    $title.html('设置彩铃');
            	    switch (query) {
            	        case "ringInfo":                                
            	            $ringInfo.show();
            	            $taskInfo.hide();
            	            $singleInfo.hide();
            	            $monthInfo.hide();
            	            /*$ring_desc.html('<li>开通彩铃包月服务（6元/月），开通后可免费不限次数的更换所有彩铃.</li><li>彩铃包月服务需开通彩铃功能（5元/月），由运营商收取；若您未开通，我们将一并为您开通；若您已开通，请忽略此项.</li>');*/
                          break;
                      case "taskInfo":
                          $taskInfo.show();
                          $ringInfo.hide();
            	            $singleInfo.hide();
            	            $monthInfo.hide();
                          /*$ring_desc.html('<li>订购单首彩铃（2元/首）</li><li>您还可以选择开通<a href="#!order/mpay">包月服务</a>，可免费不限次数的更换所有彩铃.</li><li>彩铃服务需开通彩铃功能，为了您能正常使用彩铃服务，请先确保已经开通彩铃功能.</li>');*/
                          break;
                      case "singleInfo":
                          $singleInfo.show();
                          $ringInfo.hide();
            	            $taskInfo.hide();
            	            $monthInfo.hide();
                          /*$ring_desc.html('<li>订购单首彩铃（2元/首）</li><li>您还可以选择开通<a href="#!order/mpay">包月服务</a>，可免费不限次数的更换所有彩铃.</li><li>彩铃服务需开通彩铃功能，为了您能正常使用彩铃服务，请先确保已经开通彩铃功能.</li>');*/
                          break;
                      case "monthInfo":
                          $monthInfo.show();
                          $ringInfo.hide();
            	            $taskInfo.hide();
            	            $singleInfo.hide();
                          /*$ring_desc.html('<li>订购单首彩铃（2元/首）</li><li>您还可以选择开通<a href="#!order/mpay">包月服务</a>，可免费不限次数的更换所有彩铃.</li><li>彩铃服务需开通彩铃功能，为了您能正常使用彩铃服务，请先确保已经开通彩铃功能.</li>');*/
                          break;
                      default:
                          break;
                  }
                  setInfo($ring_info, query);
                  $index.hide();
                  $order.show();
                  break;
          }
				}
			})

  		// setInfo($home_ring_info);
  		getUserInfo(function() {
          setInfo($home_ring_info, window.location.hash.split('/')[1]);
          // isDone = true;
      });      
      
			$doc.on("tap", ".isp_content", function() {
				$('.isp_content').html(window.location.href);
				return false
			})
			.on("tap", "#isp_play", function() {
				send_pause_app();
				return false
			})
			.on("tap", "#close_current", function() {
				send_close_webview();
				return false
			})
			.on("tap", "#tran_href", function() {
				open_web_view_api('www.baidu.com');
				return false
			})
			.on("tap", ".tab_type>li", function(){
				var that = $(this),
						category = that.attr('cate'),
            $box = $(that.attr("target"));
        $tabs.removeClass("choose_tab");
        that.addClass('choose_tab');
				$rlist_box.children('ul').hide();
        $box.show();
        if ($box.find('li').length == 0) {
        	ispAjax(category, $box);
        }
				return false
			})
			.on("tap", '#find', function() {
  			if ($key.val() && !isLoad) {
					isSearch = true;
  				$find.blur();
  				$key.blur();
  				$.isp['ajax']({
  					url: '//wawa.fm/ctcc/v1/api/track/list',
  					type: "POST",
  					data: { page: 1, size: 50, keys: 'songname,singer', and: "a.type=1", value:$key.val() },
  					beforeSend: function(){
  						isLoad = true;
  						$filter_info.html('<div class="yyloader"><span></span><span></span><span></span><img src="http://up.wawa.fm/21,019486d41d666e"/></div>')},
  					success: function(data){
							if (data['code'] == 1 && data['data'].length > 0) {
                  setList(data['data'], $filter_info);
              } else {
              	$filter_info.html('<p style = "text-align:center;margin-top:30px;font-size:12px;color:#9b9b9b;">对不起，系统未搜索到相关彩铃</p>');
              }
  					},
  					complete: function() {
                isLoad = false;
            }
  				})
  			}
  			return false
  		})
			.on("focus", "#key", function(event) {
  			$('.icon-search').css("opacity","1");
  			$('.search').css("opacity","1");
  			if ($key.val()) {
  				$find.css("opacity","1");
  			} else {
  				$find.css("opacity","0.3");
  			}
  			return false
  		})
  		.on("blur", "#key", function() {
  			if (!$key.val()) {
  				$('.icon-search').css("opacity","0.3");
  				$('.search').css("opacity","0.3");
  			}
  			return false
  		})
  		.on("input", "#key", function() {
  			if ($key.val()) {
  				$find.css("opacity","1");
  			} else {
  				$find.css("opacity","0.3");
  			}
  			return false
  		})
  		.on("tap", ".my_set_ring", function() {
  			com_tid = $(this).attr("tid");
  			com_songname = $(this).attr("songname");
  			$('.change_ring').css('display','block');
  			return false
  		})
  		.on('tap', '.list_states', function() {
  			var that = $(this),
            url = that.attr("file"),
            rid = that.attr("rid");
        if (url) { //有歌曲
       	    send_pause_app(); //暂停app内播放
       	    if (that.hasClass('curPlayer')) {
       	        if (audio.paused) {
       	        	$('.curPlayer').find('.icon-audio-play').removeClass("icon-audio-play").addClass("icon-pause");
       	        	$('.curPlayer>i.icon-pause').css('margin-right','14px');
       	        	audio.play()
       	        } else {
       	        	audio.pause()
       	        	$('.curPlayer').find('.icon-pause').removeClass("icon-pause").addClass("icon-audio-play");
              		$('.curPlayer>i.icon-audio-play').css('margin-right','10px');
       	        }
       	    } else {
       	      	$.yy['alert']({icon: '', word: '即将播放...'});
       	    		audioTip();
       	        that.find('.icon-audio-play').removeClass("icon-audio-play").addClass("icon-pause");
       	        that.addClass('curPlayer');
       	      	$('.curPlayer>i.icon-pause').css('margin-right','14px');
       	      	audio.src = url;
       	      	audio.play();
       	    }
       	} else { //无歌曲，需要请求
       	    audio.src = "../img/app/no.mp3";
       	    audio.play();
       	    if (rid == undefined) { //其他播放 修改
       	        $.yy['alert']({icon: '', word: '即将播放...'});
       	        $.isp['ajax']({
       	            url: '//wawa.fm/ctcc/v1/api/track/getResourceCode',
       	            type: "GET",
       	            data: { ringCode: that.attr("ringid") },
       	            success: function(data) {
       	                getUrl(data['resource_code'], function(url) {
       	                    if (url) {
       	                        that.attr("file", url);
       	                        send_pause_app(); //暂停app内播放
       	                        audioTip();
       	                				that.find('.icon-audio-play').removeClass("icon-audio-play").addClass("icon-pause");
       	      									$('.list_states>i.icon-pause').css('margin-right','14px');
       	                				that.addClass('curPlayer');
       	                        audio.src = url;
       	                        audio.play();
       	                    } else {
       	                        $.yy['alert']({ icon: 'icon-fail', word: '暂无该试听音源' });
       	                        audioTip();
       	                    }
       	                });
       	            }
       	        });
       	    }else{
       	        getUrl(rid, function(url) {
										$.yy['alert']({icon: '', word: '即将播放...'});
       	            if (url) {
       	                that.attr("file", url);
       	                send_pause_app(); //暂停app内播放
       	                audioTip();
       	        				that.find('.icon-audio-play').removeClass("icon-audio-play").addClass("icon-pause");
       	        				that.addClass('curPlayer');
       	      					$('.curPlayer>i.icon-pause').css('margin-right','14px');
       	                audio.src = url;
       	                audio.play();
       	            } else {
       	                $.yy['alert']({ icon: 'icon-fail', word: '暂无该试听音源' });
       	                audioTip();
       	            }
       	        });
       	    }
       	}
       	 return false;
  		})
  		.on('tap', '.home_ring', function() {
  			var that = $(this),
  					url = that.attr("file"),
  					rid = that.attr("rid");
  			if (url) {
 					send_pause_app();
  				audioTip();
  				if (audio.src === url) {
  					if (audio.paused) {
       	  		that.removeClass("icon-play-button").addClass("icon-pause-button");
       	  		audio.play();
  					} else {
       	  		audio.pause();
  						that.removeClass("icon-pause-button").addClass("icon-play-button");
  					}
       	    
  				} else {
  					audio.src = url;
  					that.removeClass("icon-play-button").addClass("icon-pause-button");
       	  	audio.play();
  				}
  				
  			} else {
  				if (rid) {
  					getUrl(rid, function(url) {
       		      if (url) {
       		          that.attr("file", url);
       		          send_pause_app();
       		          audioTip();
       		  				that.removeClass("icon-play-button").addClass("icon-pause-button");
       		          audio.src = url;
       		          audio.play();
       		      } else {
       		          $.yy['alert']({ icon: 'icon-fail', word: '暂无该试听音源' });
       		          audioTip();
       		      }
       		  });
  				} else {
       		    $.yy['alert']({ icon: 'icon-fail', word: '暂无该试听音源' });
       		    audioTip();
       		}
  			}
  				
  			return false
  		})
  		.on('tap', '.list_detail', function() {
  			var query = $.yy['parseJson'](location.search.substr(1));
        query['ctcc'] = $(this).attr("ctcc");
        location.href = "?" + $.yy['parseStr'](query) + '#!order/ringInfo';
        return false;
  		})
  		.on("tap", "#sbcode", function() {
          var $sbphone = $("#sbphone"),
              phone = $sbphone.val();
          if (!$(this).hasClass('disabled') && phone != '') {
              $sbphone.blur();
              $("#sbkey").blur();
              sendSpayCode(phone);
          }
          return false;
      })
      .on("tap", "#mbcode", function() {
          var $mbphone = $("#mbphone"),
              phone = $mbphone.val();
          if (!$(this).hasClass('disabled') && phone != '') {
              $mbphone.blur();
              $("#mbkey").blur();
              sendMpayCode(phone, $('#mbcode'), $('#mbkey'));
          }
          return false;
      })
      .on("keyup", "#sbphone", function() { //..
          if (/^(133|153|180|181|189|177|170)[0-9]{8}$/.test($(this).val())) {
              $("#sbcode").removeClass('disabled');
          } else {
              $("#sbcode").addClass('disabled');
          }
      })
      .on("keyup", "#mbphone", function() {
          if (/^(133|153|180|181|189|177|170)[0-9]{8}$/.test($(this).val())) {
              $("#mbcode").removeClass('disabled');
          } else {
              $("#mbcode").addClass('disabled');
          }
      })
      .on("keyup", "#mbkey", function() {
          if ($(this).val().length == 4) {
              $("#mPayOrder").removeClass('disabled');
              $("#oPayOrder").removeClass('disabled');
          }
      })
      .on("keyup", "#sbkey", function() { //..
          if ($(this).val().length == 6) {
              $("#sPayOrder").removeClass('disabled');
          }
      })
      .on("tap", "#oPayOrder", function() {
      		submitMonth($("#obphone"),$("#obkey"));
          return false
      })
      .on("tap", "#mPayOrder", function() {
          submitMonth($("#mbphone"),$("#mbkey"));
          return false
      })
      .on("tap", "#sPayOrder", function() {
                var $sbphone = $("#sbphone"),
                    $sbkey = $("#sbkey"),
                    dom = '';
                phone = $sbphone.val();
                code = $sbkey.val();
                if (crbt_id != '' && !$(this).hasClass('disabled') && phone != '' && code != '') {
                    $sbphone.blur();
                    $sbkey.blur();
                    isBase(phone, function(res) {
                        if (res) {
                            dom = '<div class="isp_tit">'+
																			'<h1 id="ring" class="change_choose" ><p>My Ring-back</p><p>业务</p></h1>'+
																	'</div>'+
																	'<div class="ring_de">'+
																		'<div class="isp_cont">'+
																			'<div class="ring_buy_type" style="margin-top: 0;">'+
																				'<p  class="progress">尊敬的 ' + phone + ' 用户，您正在订购彩铃《' + crbt_songname + '》，资费：2元/首。	</p>'+
																				'<img class="pro_phone" src="../img/yuyin/isp/Group 2.png">'+
																				'<a class="pro_buy" id="sure_buy">立即订购</a>'+
																			'</div>'+
																		'</div>'+
																		'<div class="line"></div>'+
																		'<div class="ring_tip_2"> <p>1、由广州市伟图信息技术有限公司为您提供移动信息服务</p></div>'+
 																	'</div>'
                          $taskInfo.html(dom);
                          location.href="#!order/taskInfo"
                        } else {
                            $.yy['alert']({ icon: 'icon-close', word: '请确保您已开通彩铃功能' });
                        }
                    })
                }
                return false;
      })
      .on("keyup", "#obphone", function() {
          if (/^(133|153|180|181|189|177|170)[0-9]{8}$/.test($(this).val())) {
              $("#obcode").removeClass('disabled');
          } else {
              $("#obcode").addClass('disabled');
          }
      })
      .on("keyup", "#obkey", function() {
          if ($(this).val().length == 4) {
              $("#oPayOrder").removeClass('disabled');
              $("#oPayOrder").removeClass('disabled');
          }
      })
      .on("tap", "#obcode", function() {
          var $obphone = $("#obphone"),
              phone = $obphone.val();
          if (!$(this).hasClass('disabled') && phone != '') {
              $obphone.blur();
              $("#obkey").blur();
              sendMpayCode(phone, $('#obcode'), $('#obkey'));
          }
          return false;
      })
      .on("tap", "#res_btns>a", function() {
          $res_page.hide();
          location.hash = '';
          Q.go($(this).attr('href'));
          return false;
      })
      .on("tap", "#sure_order", function() {
          order(crbt_id, phone, code);
          return false;
      })
      .on("tap", "#clearMonth", function() {
      	$.yy['confirm']({
            desc: '取消彩铃包月业务后您将不再享有免费设置彩铃的会员权益，您确认要取消吗？',
            funClass: 'sure_td',
            btnSureText: '确认取消',
            btnCancelText: '我再想想'
        });
        return false
      })
      .on("tap", ".cancel", function() {
      	$(".clearbox").remove();
      	$(".change_ring").css('display','none');
      	return false
      })
      .on("tap", ".demask", function() {
      	$(".clearbox").remove();
      	return false
      })
      .on("tap", ".sure_td", function() {
      	$(".clearbox").remove();
        TDProduct(user['phone']);
        return false;
      })
      .on("tap", "#setRing", function() {
      	setRing(crbt_id, user['phone']);
      	return false
      })
      .on("tap", "#set_my_ring", function() {
          $(".clearbox").remove();
          $.yy['confirm']({
              desc: '是否确认将《' + com_songname + '》设为当前彩铃吗？',
              funClass: 'sure_set',
              btnSureText: '确认设置',
              btnCancelText: '我再想想'
          });
          return false;
      })
      .on("tap", ".sure_set", function() {
          $(".clearbox").remove();
          setCurRing(com_tid, user['phone']);
          $(".change_ring").css('display','none');
          return false;
      })
      .on("tap", "#logout", function() {
          $(".clearbox").remove();
          $.yy['confirm']({
              desc: '<center>您确认要退出该账号吗？</center>',
              funClass: 'sure_logout',
              btnSureText: '确认退出',
              btnCancelText: '我再想想'
          });
          return false;
      })
      .on("tap", ".sure_logout", function() {
          $(".clearbox").remove();
          $("#obphone").val('');
          $("#obkey").val('');
          localStorage.removeItem('ctcc');
          getUserInfo(function() { setInfo($home_ring_info); });
          return false;
      })
      .on("tap", ".change_ring", function() {
      	$('.change_ring').hide();
      	return false
      })
      .on("tap", "#detail_none", function() {
      	window.history.back();
      	return false
      })
      .on("tap", "#sure_buy", function() {
      	buyRing(crbt_id, phone, code);
        return false;
      })
      
  		audio.addEventListener('ended', function() {
  			audioTip();
  		})
      
  		function ispAjax(category, $target) {
				$.isp['ajax']({
					url: "//wawa.fm/custom/v1/operator/list",
					type: 'POST',
					data: {
						size:50,
						page:1,
						and:'category='+category,
						order:'asc',
						by:'order'
					},
					beforeSend: function() {
            $target.html('<div class="yyloader"><span></span><span></span><span></span><img src="http://up.wawa.fm/21,019486d41d666e"/></div>');
          },
					success: function(data) {
						if (data['code'] == 1 && data['data'].length > 0) {
                setList(data['data'], $target);
            }
					},
					complete: function() {
            $("#loading").remove();
						$loading.css("display","none");
          }
				})
			}
			function setInfo($target, type) {
				if (ctcc) {
					$.isp['ajax']({
                    url: '//wawa.fm/ctcc/v1/api/track/info',
                    type: "GET",
                    data: { id: ctcc },
                    beforeSend: function() {
                    		isLoad = true;
                        $target.html('<div class="yyloader"><span></span><span></span><span></span><img src="http://up.wawa.fm/21,019486d41d666e"/></div>');
                    },
                    success: function(data) {
                        if (data['id'] != 0) {
                            var ringdom, paydom;
                            crbt_songname = data['songname'];
                            crbt_id = data['ring_code'];
 														ringdom = '<img class="ring_cover" id="home_ring_cover" src="http://up.wawa.fm/18,015414261e53c7?width=500">'+
																'<img class="ring_cover_bg" src="../img/yuyin/isp/ring_buttom_bg.png">'+
																'<i class="icon-play-button home_ring" rid="' + data['resource_code']+'"></i>'+
																'<div class="ring_name">'+
																	'<h4 class="ellipsis">'+data['singer']+'</h4>'+
																	'<h2 class="bolder">'+data['songname']+'</h2>'+
																'</div>';
                            $target.html(ringdom);

                            getUrl(data['resource_code'], function(url) {
                                if (url) {
                                    $(".home_ring").attr("file", url);
                                } else {
                                    $(".home_ring").attr("file", '');
                                }
                            });

                            if (user['phone']) { //已经登录过了
                                if (user['isOpen']) { //开通包月
                                    paydom = ('<a id="setRing" style="width: 99%;display:block;margin:auto;">免费设为彩铃</a>');
                                } else {
                                    paydom = ('<a id="first_buy" href="#!order/singleInfo">单首订购</a>				<a id="month_buy" href="#!order/monthInfo">包月订购</a> ');
                                };
                                $change_set.html(paydom);
                                $rm_ring_tip.html('');

                            } else { //没有登录过
                                paydom = ('<a id="first_buy" href="#!order/singleInfo">单首订购</a><a id="month_buy" href="#!order/monthInfo">包月订购</a> ');
                                $change_set.html(paydom);
                                $rm_ring_tip.html('<p>单首订购的咨询费为 <strong>2元/首</strong>；包月订购则为 <strong>6元/月</strong>，在期限内可免费不限次数的更换所有彩铃</p>');
                            }


                            $.isp['ajax']({ //获取图片
                                url: '//wawa.fm/ctcc/v1/api/proxy',
                                type: "GET",
                                data: {
                                    url: '/openapi/services/v2/picture/picture/findsingerpic.json?id=' + crbt_id + '&id_type=1&singer_name=&format=jpg',
                                    sign: crbt_id + '&1&&jpg'
                                },
                                success: function(data) {
                                    //console.log('查询封面：'+data);
                                    data = eval('(' + data + ')')['queryPicResponse'];
                                    if (data['res_code'] == '0000') {
                                        $(".ring_cover").attr("src", data['item']['url']);
                                    }
                                }
                            });

                        } else {
                            if (type === 'ringInfo') {
                            	$target.html('<div class="not_ring"><h1 class="bolder">中国电信暂无该彩铃</h1></div>');
                            	$change_set.html('<a id="detail_none" style="width: 99%;display:block;margin:auto;">暂无该彩铃，返回</a>');
                            } else {
                            	$target.html('<div class="not_ring"><h1 class="bolder">中国电信暂无该彩铃</h1><h2>为你推荐以下彩铃</h2></div>');
                            }

                        }
                    },
                    complete: function() {
                        isLoad = false;
                    }
          })
				} else {
					$target.html('<div class="not_ring"><h1 class="bolder">中国电信暂无该彩铃</h1><h2>为你推荐以下彩铃</h2></div>');
				}
			}
			function setList(data, $target) {
				var mainDom = '';
				for(var i = 0; i < data.length;  i++){
					mainDom += '<li class="list_re list_detail" ctcc="' + ( data[i]['copyright'] || data[i]['resource_code'] ) + '">'+
											'<div class="list_info">'+
												'<h3 class="ellipsis">'+data[i]['songname']+'</h3>'+
												'<h3 class="ellipsis">'+data[i]['singer']+'</h3>'+
											'</div>'+
											'<div class="list_states" rid="'+( data[i]['copyright'] || data[i]['resource_code'] )+'" file="'+( data[i]['file'] || '' )+'">'+
												'<i class="icon-audio-play icon_state"></i>'+
												'<span>试听</span>'+
											'</div>'+
										'</li>'
				};
				$target.html(mainDom);
			}
			function getUrl(rid, callback) { //试听 //ok
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "GET",
                data: {
                    url: '/openapi/services/v2/product/productquery/queryringdetail.json?resource_id=' + rid + '&format=mp3',
                    sign: rid + '&mp3'
                },
                success: function(data) {
                    // console.log('查询试听地址：'+data);
                    data = eval('(' + data + ')')['music_product'];
                    var url = (data['res_code'] == '0000' ? data['audioFileItemList']['audioFileItemList'][0]['file_address'] : '');
                    callback != undefined && callback(url);
                }
            });
      }
  		function audioTip() { //恢复列表歌曲、页面歌曲样式
  			$('.curPlayer').find('i').removeClass("icon-pause").addClass("icon-audio-play");
       	$('.curPlayer>i.icon-audio-play').css('margin-right','10px');
       	$('.list_states').removeClass('curPlayer');
       	$('.ring_info').find('i').removeClass("icon-pause-button").addClass("icon-play-button");
  		}
  		function getUserInfo(callback) { //获取用户信息
           	$meInfo.hide();
            $login.hide();
            user = { phone: '', isOpen: false, isBase: false, uid: 0, token: '' };
            if (localStorage['ctcc'] != undefined) {
                user = $.extend(user, JSON.parse(localStorage.getItem('ctcc')));
                console.log('已登录：' + user['phone']);
                var i = 0;
                isOpen(user['phone'], function(res) {
                    user['isOpen'] = res;
                    if (res) {
                        $mpybtn.attr("id", "clearMonth").html('取消包月');
                        
                    } else {
                        $mpybtn.attr("id", "buyMonth").html('开通包月');
                    }
                    if ((i++) == 1) { callback != undefined && callback();} //验证
                });
                isBase(user['phone'], function(res) {
                    user['isBase'] = res;
                    if ((i++) == 1) { callback != undefined && callback(); }
                });
                console.log('登陆');
                getUserList(user['phone']);
                $admin_phone.html(user['phone']);
                $meInfo.show();
            } else {
                console.log('未登录');
                callback != undefined && callback();
                $login.show();
            }
            return false;
      }
      function isBase(phone, callback) { //是否彩铃用户 //ok
            var res = false;
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "GET",
                data: {
                    url: '/openapi/services/v2/music/crbtservice/iscrbtuser.json?mdn=' + phone,
                    sign: phone
                },
                success: function(data) {
                    data = eval('(' + data + ')')['BasicJTResponse'];
                    res = (data['res_code'] == "0000" ? true : false);
                },
                complete: function() {
                    console.log('是否彩铃用户：' + res);
                    callback != undefined && callback(res);
                }
            });
      }
      function sendSpayCode(phone) { //发送单次验证码 //ok
            var i = 60,
                $sbcode = $("#sbcode"),
                $sbkey = $("#sbkey");
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "POST",
                data: {
                    url: '/openapi/services/v2/music/crbtservice/sendrandom.json',
                    mdn: phone,
                    sign: phone
                },
                beforeSend: function() {
                    $sbcode.addClass('disabled');
                    codeInterval = setInterval(function() {
                        if (i > 1) {
                            i = i - 1;
                            $sbcode.html("00:" + (i.toString().length == 1 ? "0" + i : i));
                        } else {
                            i = 60;
                            $sbcode.html("再次获取").removeClass('disabled');
                            clearInterval(codeInterval);
                        }
                    }, 1000);
                    $.yy['alert']({ icon: '', word: '正在发送...' });
                },
                success: function(data) {
                    console.log('获取单次验证码：' + data);
                    data = eval('(' + data + ')')['BasicJTResponse'];
                    if (data['res_code'] == "0000") {
                        $sbkey.focus();
                        $.yy['alert']({ icon: '', word: '验证码已发送' });
                    } else {
                        $.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                    }
                }
            });
      }
      function sendMpayCode(phone,$target1,$target2) { //发送包月验证码 //ok
            var i = 60,
                $mbcode = $target1,
                $mbkey = $target2;
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "POST",
                data: {
                    url: '/openapi/services/v2/package/packageservice/emplanunched.json',
                    mdn: phone,
                    package_id: '135000000000000248377',
                    column: '',
                    sign: phone + '&135000000000000248377&'
                },
                beforeSend: function() {
                    $mbcode.addClass('disabled');
                    codeInterval = setInterval(function() {
                        if (i > 1) {
                            i = i - 1;
                            $mbcode.html("00:" + (i.toString().length == 1 ? "0" + i : i));
                        } else {
                            i = 60;
                            $mbcode.html("再次获取").removeClass('disabled');
                            clearInterval(codeInterval);
                        }
                    }, 1000);
                    $.yy['alert']({ icon: 'icon-success', word: '正在发送...' });
                },
                success: function(data) {
                    console.log('获取单次验证码：' + data);
                    data = eval('(' + data + ')')['EmpPackageResp'];
                    if (data['res_code'] == "0") {
                        $mbkey.focus();
                        $.yy['alert']({ icon: 'icon-success', word: '验证码已发送' });
                    } else {
                        $.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                    }
                }
            });
      }
      function isOpen(phone, callback) { //是否开通包月 //ok
            var res = false;
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "GET",
                data: {
                    url: '/openapi/services/v2/qd/cooperateservice/queryuserpackagelist.json?number=' + phone + '&package_id=135000000000000248377',
                    sign: phone + '&135000000000000248377'
                },
                success: function(data) {
                    data = eval('(' + data + ')')['UserPackageListResp'];
                    if (data['res_code'] == "0000") {
                        if (data['user_package_list']['user_package']['package_id'] == '135000000000000248377' && data['user_package_list']['user_package']['status'] == 0) {
                            res = true;
                        }
                    }
                },
                complete: function() {
                    console.log('是否包月用户：' + res);
                    callback != undefined && callback(res);
                }
            });
      }
      function openProduct(mdn, random_key) { //开通包月+（彩铃）  //ok
            isBase(mdn, function(res) {
                if (res) { //彩铃用户
                    $.isp['ajax']({
                        url: '//wawa.fm/ctcc/v1/api/proxy',
                        type: "POST",
                        data: {
                            url: '/openapi/services/v2/package/packageservice/subscribebyemp.json',
                            mdn: mdn,
                            package_id: '135000000000000248377',
                            random_key: random_key,
                            column: '',
                            sign: mdn + '&135000000000000248377&' + random_key + '&'
                        },
                        beforeSend: function() {
                            $.yy['alert']({ icon:'',word: '正在开通...' });
                        },
                        success: function(data) {
                            /*texData = data.BasicJTResponse;  //验证码有误继续操作。
                            console.log('开通包月：' + data,texData);
                            texMess = texData["res_message"];
                            if (texMess === '验证码错误!') {
                            	return false
                            }*/
                            console.log('开通包月：' + data);
                            data = eval('(' + data + ')')['BasicJTResponse'];
                            isOpen(mdn, function(res) { //由于返回不一定0000，所以直接查询是否包月成功
                                if (res) {
                                    localStorage.setItem('ctcc', JSON.stringify({ uid: 0, phone: mdn, token: '' }));
                                    resPage('success', '开通成功', '已经为您成功开通包月服务', [
                                        { text: '返回首页', url: '#!index/home' }, { text: '管理彩铃', url: '#!index/user' }
                                    ]);
                                    getUserInfo(function() { setInfo($home_ring_info); }); //修改
                                } else {
                                    $.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                                }
                            });
                        }
                    });
                }else{
                    $.isp['ajax']({
                        url: '//wawa.fm/ctcc/v1/api/proxy',
                        type: "POST",
                        data: {
                            url: '/openapi/services/v2/package/packageservice/orderpackage_opencrbt_by_emp.json',
                            mdn: mdn,
                            random_key: random_key,
                            package_id: '135000000000000248377',
                            column: '',
                            sign: mdn + '&' + random_key + '&135000000000000248377&'
                        },
                        beforeSend: function() {
                            $.yy['alert']({ icon: '', word: '正在开通...'});
                        },
                        success: function(data) {
                            console.log('开通彩铃+包月：' + data);
                            /*if (data['BasicJTResponse']['res_message']==='验证码错误!') {
                            	return false
                            }*/
                            data = eval('(' + data + ')')['BasicJTResponse'];
                            isOpen(mdn, function(res) { //由于返回不一定0000，所以直接查询是否包月成功
                                if (res) {
                                    localStorage.setItem('ctcc', JSON.stringify({ uid: 0, phone: mdn, token: '' }));
                                    resPage('success', '开通成功', '已为您成功开通彩铃和包月服务', [
                                        { text: '返回首页', url: '#!index/home' }, { text: '管理彩铃', url: '#!index/user' }
                                    ]);
                                    getUserInfo(function() { setInfo($home_ring_info); });
                                } else {
                                    $.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                                }
                            });
                        }
                    });
                }
            })
      }
      function resPage(type, title, desc, btns) { //开通成功
            $rpage.hide();
            $(".clearbox").remove();
            var btndom = '';
            for (var i = 0; i < btns.length; i++) {
                btndom += '<a class="btn mbtn" href="' + btns[i]['url'] + '">' + btns[i]['text'] + '</a>';
            }
            $res_btns.html(btndom);
            if (type=="error") {
            	$res_icon.removeClass('icon-success icon-info').addClass('icon-close');
            } else if (type == "success") {
            	$res_icon.removeClass('icon-close icon-info').addClass('icon-success');
            } else {
            	$res_icon.removeClass('icon-close icon-success').addClass('icon-info');
            }
            $res_title.html(title);
            $res_desc.html(desc);
            $res_page.show();
            return false;
      }
      function getUserList(mdn, callback) { //查询个人铃音 //ok
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "GET",
                data: {
                    url: '/openapi/services/v2/music/crbtservice/queryring.json?mdn=' + mdn + '&page=0&count=100',
                    sign: mdn + '&0&100'
                },
                beforeSend: function() {
                    $ulist_box.html('<div class="yyloader"> <span></span> <span></span> <span></span> <img src="http://up.wawa.fm/21,019486d41d666e"/> </div>');
                },
                success: function(data) {
                    //console.log('查询个人铃音：'+data);
                    var dom = '';
                    data = eval('(' + data + ')')['queryRingResponse'];
                    if (data['res_code'] == '0000') {
                        var list = data['ring_item'],
                            len = 0;
                        if ($.isArray(list)) {
                            len = list.length;
                        } else {
                            list = new Array(list);
                            len = 1;
                        }
                        if (len > 0) {
                            for (var i = 0; i < len; i++) {
                            		dom += 	'<li class="list_re">'+
																				'<div class="list_info my_set_ring" songname='+list[i]['ringName']+' tid="' +list[i]['ringId']+ '">'+
																					'<h3 class="ellipsis">'+list[i]['ringName']+'</h3>'+
																					'<h3 class="ellipsis">'+list[i]['author']+'</h3>'+
																				'</div>'+
																				'<div class="list_states" ringid="' +list[i]['ringId']+ '"  file="">'+
																						'<i class="icon-audio-play icon_state"></i>'+
																						'<span>试听</span>'+
																					'</div>'+
																				'</li>';
                            }
                        }
                        $ulist_num.html(len);
                    } else {
                        dom = '<p class="ring_none">暂无彩铃</p>';
                    }
                    $ulist_box.html(dom);
                }
            });
      }
      function order(crbt_id, mdn, random_key) { //开通(彩铃)+包月+订购  //ok
            isBase(mdn, function(res) {
                if (res) { //彩铃用户
                    $.isp['ajax']({
                        url: '//wawa.fm/ctcc/v1/api/proxy',
                        type: "POST",
                        data: {
                            url: '/openapi/services/v2/package/packageservice/subscribebyemp.json',
                            mdn: mdn,
                            package_id: '135000000000000248377',
                            random_key: random_key,
                            column: '',
                            sign: mdn + '&135000000000000248377&' + random_key + '&'
                        },
                        beforeSend: function() {
                            $.yy['alert']({ icon: '', word: '正在设置...'});
                        },
                        success: function(data) {
                            console.log('开通包月：' + data);
                            data = eval('(' + data + ')')['BasicJTResponse'];
                            isOpen(mdn, function(res) {
                                if (res) {
                                    localStorage.setItem('ctcc', JSON.stringify({ uid: 0, phone: mdn, token: '' }));
                                    getUserInfo(function() { setInfo($home_ring_info); });
                                    $.isp['ajax']({ //设为免费彩铃
                                        url: '//wawa.fm/ctcc/v1/api/proxy',
                                        type: "POST",
                                        data: {
                                            url: '/openapi/services/v2/music/customcrbtservice/order_nofee.json',
                                            mdn: mdn,
                                            package_id: '135000000000000248377',
                                            crbt_id: crbt_id,
                                            type: "1",
                                            set_default_crbt: 1,
                                            sign: mdn + '&135000000000000248377&' + crbt_id + '&1&1'
                                        },
                                        success: function(data) {
                                            console.log('设置免费彩铃：' + data);
                                            data = eval('(' + data + ')');
                                            if ($.inArray(data['res_code'], ["0000", "0531", "0536"]) != -1) {
                                                resPage('success', '设置成功', '已经开通包月服务，并将《' + crbt_songname + '》设置为当前彩铃。', [
                                                    { text: '返回首页', url: '#!index/home' }, { text: '管理彩铃', url: '#!index/user' }
                                                ]);

                                            } else {
                                            	if (data['res_message'].substr(0,16) == "定购铃音,用户业务状态不允许下载") {
                                            		$.yy['alert']({ icon:'icon-info', word:'请求已受理,请留意短信通知'});
                                            	} else {
                                            		$.yy['alert']({ icon:'icon-close', word:data['res_message'] });
                                            	}
                                            	Q.go("#!index/user");
                                            }
                                        }
                                    });
                                } else {
                                    $.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                                    Q.go("#!index/user");
                                }
                            });
                        }
                    });
                } else {
                    $.isp['ajax']({
                        url: '//wawa.fm/ctcc/v1/api/proxy',
                        type: "POST",
                        data: {
                            url: '/openapi/services/v2/package/packageservice/orderpackage_opencrbt_crbt_by_emp.json',
                            mdn: mdn,
                            random_key: random_key,
                            package_id: '135000000000000248377',
                            crbt_id: crbt_id,
                            column: '',
                            sign: mdn + '&' + random_key + '&135000000000000248377&' + crbt_id + '&'
                        },
                        beforeSend: function() {
                            $.yy['alert']({ icon: '', word: '正在设置...' });
                        },
                        success: function(data) {
                            console.log('开通包月+基础功能+设置彩铃：' + data);
                            data = eval('(' + data + ')')['BasicJTResponse'];
                            isOpen(mdn, function(res) { //由于返回不一定0000，所以直接查询是否包月成功
                                if (res) {
                                    localStorage.setItem('ctcc', JSON.stringify({ uid: 0, phone: mdn, token: '' }));
                                    resPage('success', '设置成功', '已经开通彩铃功能和包月服务，并将《' + crbt_songname + '》设置为当前彩铃。', [
                                        { text: '返回首页', url: '#!index/home' }, { text: '管理彩铃', url: '#!index/user' }
                                    ]);
                                    getUserInfo(function() { setInfo($home_ring_info); });
                                } else {
                                	if (data['res_message'].substr(0,16) == "定购铃音,用户业务状态不允许下载") {
                                  	$.yy['alert']({ icon:'icon-info', word:'请求已受理,请留意短信通知'});
                                  } else {
                                  	$.yy['alert']({ icon:'icon-close', word:data['res_message'] });
                                  }
                                }
                            });
                        }
                    });
                }
            });
      }
      function TDProduct(mdn) { //退订
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "POST",
                data: {
                    url: '/openapi/services/v2/package/packageservice/unsubscribebyemp.json',
                    mdn: mdn,
                    package_id: '135000000000000248377',
                    sign: mdn + '&135000000000000248377'
                },
                beforeSend: function() {
                    $.yy['alert']({ icon: '', word: '正在取消...' });
                },
                success: function(data) {
                    console.log('退订彩铃：' + data);
                    data = eval('(' + data + ')')['BasicJTResponse'];
                    if (data['res_code'] == "0") {
                        resPage('success', '取消成功', '您申请取消彩铃包月业务已成功受理，请留意业务通知短信。', [
                            { text: '返回首页', url: '#!index/home' }
                        ]);
                        localStorage.removeItem('ctcc');
                        getUserInfo(function() { setInfo($home_ring_info); });
                    } else {
                        $.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                    }
                }
            });
      }
      function submitMonth($target1,$target2) { //主页包月、详情页包月提交
      	var 	$obphone = $target1,
              $obkey = $target2,
              desc = '',
              dom = '';
          phone = $obphone.val();
          code = $obkey.val();
          if (!$(this).hasClass('disabled') && phone != '' && code != '') {
              $obphone.blur();
              $obkey.blur();
              isOpen(phone, function(res) {
                  if (res) {
                      openProduct(phone, code);
                  } else {
                      isBase(phone, function(res) {
                          if (!res) {
                              desc = '<br/>您暂未开通彩铃基础功能，为了保证能正常使用彩铃，我们将一并开通该功能，资费：5元/月。';
      	                  }
      	                  dom = '<div class="isp_tit">'+
																			'<h1 id="ring" class="change_choose" ><p>My Ring-back</p><p>业务</p></h1>'+
																	'</div>'+
																	'<div class="ring_de">'+
																		'<div class="isp_cont">'+
																			'<div class="ring_buy_type" style="margin-top: 0;">'+
																				'<p  class="progress">尊敬的 ' + phone + ' 用户，您正在开通挖哇炫铃包月业务，资费：6元/月，开通后可免费设置彩铃。' + desc + '</p>'+
																				'<img class="pro_phone" src="../img/yuyin/isp/Group 2.png">'+
																				'<a class="pro_buy" id="sure_order">立即订购</a>'+
																			'</div>'+
																		'</div>'+
																		'<div class="line"></div>'+
																		'<div class="ring_tip_2"> <p>1、由广州市伟图信息技术有限公司为您提供移动信息服务</p><p>2、业务退订方式： 进入「我的」页面 - 点击「取消包月」 - 完成退订</p> </div>'+
 																	'</div>'
                          $taskInfo.html(dom);
                          location.href="#!order/taskInfo"
                      })
                  }
              });
          }
          return false;
      }
      function setRing(crbt_id, mdn) { //设置彩铃 //ok
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "POST",
                data: {
                    url: '/openapi/services/v2/music/customcrbtservice/order_nofee.json',
                    mdn: mdn,
                    package_id: '135000000000000248377',
                    crbt_id: crbt_id,
                    type: "1",
                    set_default_crbt: 1,
                    sign: mdn + '&135000000000000248377&' + crbt_id + '&1&1'
                },
                beforeSend: function() {
                    $.yy['alert']({ icon: '', word: '正在设置...' });
                },
                success: function(data) {
                    console.log('设置免费彩铃：' + data);
                    data = eval('(' + data + ')');
                    if (data['res_code'] == "0000" || data['res_code'] == "0531" || data['res_code'] == "0536") {
                        resPage('success', '设置成功', '已经将《' + crbt_songname + '》加入您的铃音库并设置为当前彩铃。', [
                            { text: '返回首页', url: '#!index/home' }, { text: '管理彩铃', url: '#!index/user' }
                        ]);
                        getUserInfo(function() { setInfo($home_ring_info); });
                    } else {
                        if (data['res_message'].substr(0,16) == "定购铃音,用户业务状态不允许下载") {
                       			$.yy['alert']({ icon:'icon-info', word:'请求已受理,请留意短信通知'});
                        	} else {
                        		$.yy['alert']({ icon:'icon-close', word:data['res_message'] });
                        	}
                    }
                }
            });
      }
      function setCurRing(crbt_id, mdn) { //设为当前彩铃 //ok
      	console.log(crbt_id,mdn,111);
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "POST",
                data: {
                    url: '/openapi/services/v2/music/crbtservice/setring.json',
                    mdn: mdn,
                    crbt_id: crbt_id,
                    sign: mdn + '&' + crbt_id
                },
                beforeSend: function() {
                    $.yy['alert']({ icon: '', word: '正在设置...' });
                },
                success: function(data) {
                    console.log('设为当前彩铃：' + data);
                    data = eval('(' + data + ')')['BasicJTResponse'];
                    if (data['res_code'] == "0000") {
                        $.yy['alert']({ icon: 'icon-success', word: '设置成功' });
                    } else {
                        $.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                    }
                }
            });
      }
      function buyRing(crbt_id, mdn, random_key) { //订购单首彩铃  //ok
            $.isp['ajax']({
                url: '//wawa.fm/ctcc/v1/api/proxy',
                type: "POST",
                data: {
                    url: '/openapi/services/v2/music/crbtservice/order.json',
                    mdn: mdn,
                    crbt_id: crbt_id,
                    type: "1",
                    random_key: random_key,
                    set_default_crbt: 1,
                    sign: mdn + '&' + crbt_id + '&1&' + random_key + '&1'
                },
                beforeSend: function() {
                    $.yy['alert']({ icon: '', word: '正在设置...' });
                },
                success: function(data) {
                    console.log('购买单首彩铃：' + data);
                    data = eval('(' + data + ')')['BasicJTResponse'];
                    $(".toast").remove();
                    if (data['res_code'] == "0000" || data['res_code'] == "0536") {
                        resPage('success', '设置成功', '已经将《' + crbt_songname + '》加入您的铃音库并设置为当前彩铃。', [
                            { text: '返回首页', url: '#!index/home' }
                        ]);
                        getUserInfo(function() { setInfo($home_ring_info); });
                    } else {
												$.yy['alert']({ icon: 'icon-close', word: data['res_message'] });
                        window.history.back();
                    }
                }
            });
      }


			$tabs.eq(0).trigger('tap');
		});

			
	</script>
</body>
</html>